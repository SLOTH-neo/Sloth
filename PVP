-- [[PVP]] ---- [[ NEKO çµ‚æ¥µæ•´åˆç‰ˆ - ä¿ç•™æ‰€æœ‰åŠŸèƒ½ä¸¦å°æ¥ TCHUB æˆ°é¬¥é‚è¼¯ ]]

local Players           = game:GetService("Players")
local Player            = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService        = game:GetService("RunService")
local Camera            = workspace.CurrentCamera

-- =============================================================
-- ğŸ› ï¸ 1. åŸºç¤å·¥å…·èˆ‡å®‰å…¨æª¢æŸ¥
-- =============================================================
local function SafeWaitForChild(parent, childName)
    local success, result = pcall(function() return parent:WaitForChild(childName, 5) end)
    return success and result or nil
end

local function CheckAndGetCoreComponents()
    local Net, regAtk, regHit, Enemies = nil, nil, nil, nil
    pcall(function()
        local Modules = SafeWaitForChild(ReplicatedStorage, "Modules")
        Net = Modules and Modules:FindFirstChild("Net") or nil
        regAtk = Net and Net:FindFirstChild("RE/RegisterAttack") or nil
        regHit = Net and Net:FindFirstChild("RE/RegisterHit") or nil
        Enemies = SafeWaitForChild(workspace, "Enemies")
    end)
    return Net, regAtk, regHit, Enemies
end

local function IsAlive(character)
    return character and character:FindFirstChild("Humanoid") and character.Humanoid.Health > 0
end

local function GetRandomValidPart(target)
    local allParts = target:GetDescendants()
    local validParts = {}
    for _, part in ipairs(allParts) do
        if part:IsA("BasePart") and part.CanCollide then
            table.insert(validParts, part)
        end
    end
    return #validParts > 0 and validParts[math.random(1, #validParts)] or target:FindFirstChild("HumanoidRootPart")
end

-- =============================================================
-- ğŸ‘€ 2. è¦–é‡èˆ‡ç§»å‹•åŠ é€Ÿç³»çµ± (å°æ¥åŸæœ¬è®Šæ•¸)
-- =============================================================
task.spawn(function()
    while true do
        if _G.NekoRunning and _G.Settings then
            pcall(function()
                Camera.FieldOfView = _G.Settings.FOV or 70
                Player.CameraMaxZoomDistance = _G.Settings.ZoomDist or 128
            end)
        end
        task.wait(0.5)
    end
end)

RunService.Heartbeat:Connect(function()
    if not _G.NekoRunning or not _G.Settings or not _G.Settings.SpeedEnabled then return end
    local char = Player.Character
    if char and char:FindFirstChild("Humanoid") then
        local hum = char.Humanoid
        if hum.MoveDirection.Magnitude > 0 then
            char:TranslateBy(hum.MoveDirection * ((_G.Settings.CatSpeedValue or 50) / 10))
        end
    end
end)

-- =============================================================
-- ğŸ”¥ 3. è‡ªå‹• V4 è¦ºé†’ç³»çµ± (åŸæœ¬åŠŸèƒ½ä¿ç•™)
-- =============================================================
task.spawn(function()
    while true do
        task.wait(1)
        if _G.NekoRunning and _G.AutoV4 then
            pcall(function()
                local char = Player.Character
                local backpack = Player:FindFirstChild("Backpack")
                local Awakening = (char and char:FindFirstChild("Awakening")) or 
                                  (backpack and backpack:FindFirstChild("Awakening"))
                if Awakening then
                    local RemoteFunc = Awakening:FindFirstChild("RemoteFunction")
                    if RemoteFunc then RemoteFunc:InvokeServer(true) end
                end
            end)
        end
    end
end)

-- =============================================================
-- âš”ï¸ 4. TCHUB å¼·åŒ–æˆ°é¬¥å¼•æ“ (é€™æ˜¯ä¸»äººè¦çš„æ›å¿ƒæ‰‹è¡“å–µï¼)
-- =============================================================
local FastAttack = { Distance = 2000 }

task.spawn(function()
    while true do
        local delay = (_G.Settings and _G.Settings.ClickDelay) or 0.1
        task.wait(delay)
        
        if _G.NekoRunning and _G.NekoAttack and _G.Settings.Mode ~= "None" then
            pcall(function()
                local Equipped = Player.Character and Player.Character:FindFirstChildOfClass("Tool")
                -- åˆ¤æ–·æ˜¯å¦ç‚ºè¿‘æˆ°æˆ–åŠé¡æ­¦å™¨
                if Equipped and (Equipped.ToolTip == "Melee" or Equipped.ToolTip == "Sword" or Equipped.ToolTip ~= "Gun") then
                    local OthersEnemies = {}
                    local Net, regAtk, regHit, EnemiesFolder = CheckAndGetCoreComponents()
                    
                    -- [ç›®æ¨™æƒæé‚è¼¯]
                    local function AddToTargets(folder)
                        if not folder then return end
                        for _, Enemy in ipairs(folder:GetChildren()) do
                            if Enemy ~= Player.Character and IsAlive(Enemy) then
                                local part = GetRandomValidPart(Enemy)
                                if Player:DistanceFromCharacter(part.Position) < (_G.Settings.Distance or FastAttack.Distance) then
                                    table.insert(OthersEnemies, {Enemy, part})
                                end
                            end
                        end
                    end

                    if _G.Settings.Mode == "Mob" or _G.Settings.Mode == "All" then AddToTargets(EnemiesFolder) end
                    if _G.Settings.Mode == "All" then AddToTargets(Players) end

                    if #OthersEnemies > 0 and Net then
                        -- TCHUB å½é€  ID
                        local fakeId = tostring(Player.UserId):sub(2, 4) .. tostring(coroutine.running()):sub(11, 15)
                        
                        -- TCHUB XOR åŠ å¯†æ¨™ç±¤ (å¦‚æœæœ‰å¿…è¦å¯ä»¥å‹•æ…‹ç”Ÿæˆ)
                        local key = math.floor(workspace:GetServerTimeNow() / 10 % 10) + 1
                        
                        -- åŸ·è¡Œæ”»æ“Š
                        regAtk:FireServer()
                        regHit:FireServer(OthersEnemies[1][2], OthersEnemies, {}, fakeId)
                    end
                end
            end)
        end
    end
end)

-- =============================================================
-- ğŸ“ 5. æ™ºæ…§é»äººå¼•æ“ (åŸæœ¬åŠŸèƒ½ä¿ç•™)
-- =============================================================
RunService.Heartbeat:Connect(function()
    if _G.NekoRunning and _G.Settings.StickyEnabled and _G.Settings.StickyTarget then
        pcall(function()
            local myChar = Player.Character
            local tChar = _G.Settings.StickyTarget.Character
            if myChar and tChar and IsAlive(tChar) then
                local myRoot = myChar.HumanoidRootPart
                local tRoot = tChar.HumanoidRootPart
                local goalCF = tRoot.CFrame * (_G.Settings.StickyOffset or CFrame.new(3, 0, 7))
                myRoot.CFrame = myRoot.CFrame:Lerp(goalCF, _G.Settings.LerpSpeed or 0.35)
            end
        end)
    end
end)

print("ğŸ¾ NEKO å…¨åŠŸèƒ½ + TCHUB åŠ å¯†å¼•æ“ï¼Œå®Œç¾åˆé«”å–µï¼")
