-- [[PVP]] --
local Players           = game:GetService("Players")
local Player            = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService        = game:GetService("RunService")
local Camera            = workspace.CurrentCamera

-- =============================================================
-- ğŸ› ï¸ 1. åŸºç¤å·¥å…·èˆ‡å®‰å…¨æª¢æŸ¥
-- =============================================================
local function SafeWaitForChild(parent, childName)
    local success, result = pcall(function() return parent:WaitForChild(childName, 5) end)
    return success and result or nil
end

local function CheckAndGetCoreComponents()
    local Remotes, Modules, Net, RegisterAttack, RegisterHit, Enemies = nil, nil, nil, nil, nil, nil
    pcall(function()
        Remotes = SafeWaitForChild(ReplicatedStorage, "Remotes")
        Modules = SafeWaitForChild(ReplicatedStorage, "Modules")
        Net = Modules and Modules:FindFirstChild("Net") or nil
        RegisterAttack = Net and Net:FindFirstChild("RE/RegisterAttack") or nil
        RegisterHit = Net and Net:FindFirstChild("RE/RegisterHit") or nil
        Enemies = SafeWaitForChild(workspace, "Enemies")
    end)
    return Remotes, Net, RegisterAttack, RegisterHit, Enemies
end

local function IsAlive(character)
    return character and character:FindFirstChild("Humanoid") and character.Humanoid.Health > 0
end

local function GetRandomValidPart(target)
    local allParts = target:GetDescendants()
    local validParts = {}
    for _, part in ipairs(allParts) do
        if part:IsA("BasePart") and part.CanCollide then
            table.insert(validParts, part)
        end
    end
    return #validParts > 0 and validParts[math.random(1, #validParts)] or target:FindFirstChild("HumanoidRootPart")
end

-- =============================================================
-- ğŸš€ 2. ç•°æ­¥æ”»æ“Šåˆ†é…å™¨ (Async Dispatcher)
-- =============================================================
local function FireAttackAsync(targetPart, enemyTable, regAtk, regHit, delay)
    -- ä½¿ç”¨ task.spawn å¯¦ç¾ç•°æ­¥ï¼Œå®Œå…¨ä¸ä½”ç”¨ä¸»ç·šç¨‹ç­‰å¾…æ™‚é–“
    task.spawn(function()
        pcall(function()
            regAtk:FireServer(delay)
            regHit:FireServer(targetPart, enemyTable)
        end)
    end)
end

-- =============================================================
-- âš”ï¸ 3. æ”»æ“Šå¾ªç’°å¼•æ“
-- =============================================================
task.spawn(function()
    while true do
        local delay = (_G.Settings and _G.Settings.ClickDelay) or 0.1
        task.wait(delay)
        
        if _G.NekoRunning and _G.NekoAttack and _G.Settings.Mode ~= "None" then
            pcall(function()
                local char = Player.Character
                local equipped = char and char:FindFirstChildOfClass("Tool")
                
                if equipped and equipped.ToolTip ~= "Gun" then
                    local OthersEnemies = {}
                    local _, _, regAtk, regHit, EnemiesFolder = CheckAndGetCoreComponents()
                    
                    if EnemiesFolder and regAtk and regHit then
                        -- ç²å–ç›®æ¨™ (æ€ªç‰©/ç©å®¶)
                        local Part1 = (_G.Settings.Mode == "Mob" or _G.Settings.Mode == "All") and ProcessEnemies(OthersEnemies, EnemiesFolder) or nil
                        local Part2 = (_G.Settings.Mode == "All") and ProcessRealPlayers(OthersEnemies) or nil
                        local target = Part1 or Part2
                        
                        if target and #OthersEnemies > 0 then
                            -- ğŸŒŸ ç•°æ›²åŒæ­¥å¯¦è¸ï¼šä¸€æ¬¡å¾ªç’°å™´å°„å¤šå€‹æ”»æ“ŠåŒ…
                            local multiplier = (_G.Settings.AttackMultiplier or 1)
                            for i = 1, multiplier do
                                FireAttackAsync(target, OthersEnemies, regAtk, regHit, delay)
                            end
                        end
                    end
                end
            end)
        end
    end
end)

-- =============================================================
-- ğŸƒ 4. é‹å‹•èˆ‡è¦–é‡ç³»çµ± (å°æ¥ _G è®Šæ•¸)
-- =============================================================
RunService.Heartbeat:Connect(function()
    if not _G.NekoRunning or not _G.Settings or not _G.Settings.SpeedEnabled then return end
    local char = Player.Character
    if char and char:FindFirstChild("Humanoid") then
        local hum = char.Humanoid
        if hum.MoveDirection.Magnitude > 0 then
            char:TranslateBy(hum.MoveDirection * ((_G.Settings.CatSpeedValue or 50) / 10))
        end
    end
end)

task.spawn(function()
    while true do
        if _G.NekoRunning and _G.Settings then
            pcall(function()
                Camera.FieldOfView = _G.Settings.FOV or 70
                Player.CameraMaxZoomDistance = _G.Settings.ZoomDist or 128
            end)
        end
        task.wait(0.5)
    end
end)

-- =============================================================
-- ğŸ“ 5. æ™ºæ…§é»äººå¼•æ“ (PVP å¿…å‚™)
-- =============================================================
RunService.Heartbeat:Connect(function()
    if _G.NekoRunning and _G.Settings.StickyEnabled and _G.Settings.StickyTarget then
        pcall(function()
            local myChar = Player.Character
            local tChar = _G.Settings.StickyTarget.Character
            if myChar and tChar and IsAlive(tChar) then
                local myRoot = myChar.HumanoidRootPart
                local tRoot = tChar.HumanoidRootPart
                local goalCF = tRoot.CFrame * (_G.Settings.StickyOffset or CFrame.new(3, 0, 7))
                
                if (myRoot.Position - goalCF.Position).Magnitude > (_G.Settings.SnapDistance or 500) then
                    myRoot.CFrame = goalCF 
                else
                    myRoot.CFrame = myRoot.CFrame:Lerp(goalCF, _G.Settings.LerpSpeed or 0.35)
                end
            end
        end)
    end
end)

print("ğŸ¾ NEKO PROJECT å®Œå…¨é«” (ç•°æ­¥æ”»æ“Šç‰ˆ) è¼‰å…¥æˆåŠŸå–µï¼")
