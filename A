-- Neko Project - 美化載入 + 防卡死版
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")

local lp = Players.LocalPlayer
local mainScriptUrl = "https://raw.githubusercontent.com/SLOTH-neo/Sloth/refs/heads/main/NEKO"

-- ScreenGui 建立（同之前）
local sg = Instance.new("ScreenGui")
sg.Name = "NekoLoadingScreen"
sg.ResetOnSpawn = false
sg.IgnoreGuiInset = true
pcall(function() sg.Parent = CoreGui end)
if not sg.Parent then sg.Parent = lp:WaitForChild("PlayerGui") end

-- 背景、card、title、status、bar 等 UI 部分保持不變（複製你之前的就好，這裡省略重複代碼）

-- 只貼關鍵動畫 + 載入部分
task.spawn(function()
    -- ... (你的進度條填充 tween 等)

    fillTween.Completed:Wait()
    
    status.Text = "喵～ 已連結完成！"
    status.TextColor3 = Color3.fromRGB(180, 255, 200)

    task.wait(0.8)

    -- 先縮小消失 UI（不管載入成功與否，都讓畫面關掉，避免卡住）
    local disappear = TweenService:Create(card, TweenInfo.new(0.7, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
        Size = UDim2.new(0,0,0,0),
        Position = UDim2.new(0.5,0,0.5,0),
        BackgroundTransparency = 1
    })
    disappear:Play()

    disappear.Completed:Connect(function()
        sg:Destroy()

        -- 通知「開始載入主腳本」
        StarterGui:SetCore("SendNotification", {
            Title = "Neko Loader",
            Text = "正在喚醒 NEKO 主核心... 請稍候喵～",
            Duration = 6
        })

        -- 防卡死：用 coroutine + timeout 載入
        task.spawn(function()
            local success, result = pcall(function()
                local startTime = tick()
                local content = game:HttpGet(mainScriptUrl, true)  -- 加 true 強制 cache
                if tick() - startTime > 15 then
                    error("HttpGet 超時 (>15s)")
                end
                return content
            end)

            if success and result and result ~= "" then
                local func, err = loadstring(result)
                if func then
                    local execSuccess, execErr = pcall(func)
                    if not execSuccess then
                        warn("[Neko Loader] 主腳本執行錯誤: " .. tostring(execErr))
                        StarterGui:SetCore("SendNotification", {Title = "Neko 錯誤", Text = "核心啟動失敗... 但 UI 已載入完畢！", Duration = 10})
                    else
                        print("[Neko Loader] 主腳本成功執行！")
                    end
                else
                    warn("[Neko Loader] loadstring 失敗: " .. tostring(err))
                    StarterGui:SetCore("SendNotification", {Title = "Neko 錯誤", Text = "腳本解析失敗 (loadstring err)", Duration = 10})
                end
            else
                warn("[Neko Loader] HttpGet 失敗: " .. tostring(result))
                StarterGui:SetCore("SendNotification", {
                    Title = "Neko 載入失敗",
                    Text = "無法連線到主腳本... 檢查網路 / executor / GitHub 連結？",
                    Duration = 12
                })
            end
        end)
    end)
end)

-- 呼吸動畫保持
