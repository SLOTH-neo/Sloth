-- [[主腳本]] --
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local localPlayer = Players.LocalPlayer

if getgenv().NEKO_RUNNING then return end
getgenv().NEKO_RUNNING = true

-- 1. 核心配置表 (已加入 FOV)
_G.Settings = {
    ClickDelay    = 0.1,
    Distance      = 5000,
    PullEnemies   = false,
    Mode          = "None",
    FOV           = 80,   -- 預設視野角度
    MaxZoom       = 128,  -- 預設鏡頭距離
    CatSpeedValue = 50,
    SpeedEnabled  = false,
    InfJump       = false,
    SuperJumpEnabled = false,
    SuperJumpHeight = 150,
    StickyEnabled = false,
    StickyTarget  = nil,
    StickyOffset  = CFrame.new(3, 0, 7),
    SnapDistance  = 500,
    LerpSpeed     = 0.35,
    AutoBuyFruit  = false,
    FruitESP      = false
}

_G.NekoRunning = true
_G.NekoAttack  = false
_G.AutoV4      = false
_G.NekoESP     = false

local Remote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")

-- 2. 核心渲染循環 (視野縮放的核心喵！)
task.spawn(function()
    local Camera = workspace.CurrentCamera
    RunService.RenderStepped:Connect(function()
        if not _G.NekoRunning then return end
        pcall(function()
            -- ✨ 來自他的視野縮放邏輯 (強行寫入)
            Camera.FieldOfView = _G.Settings.FOV
            
            -- ✨ 主人原本的距離縮放邏輯
            localPlayer.CameraMaxZoomDistance = _G.Settings.MaxZoom
            localPlayer.CameraMinZoomDistance = 0
            
            -- 移動與跳躍同步
            local char = localPlayer.Character
            if char and char:FindFirstChild("Humanoid") then
                local hum = char.Humanoid
                if _G.Settings.SpeedEnabled then
                    hum.WalkSpeed = _G.Settings.CatSpeedValue
                end
            end
        end)
    end)
end)

-- 清理舊 UI
local function NuclearClean()
    local targets = {"NEKO BF", "NekoUI", "NekoTerminal_Lib", "NekoStickyMenu", "NekoMainBtn", "NekoFruitESP"}
    for _, name in ipairs(targets) do
        local obj = CoreGui:FindFirstChild(name) or localPlayer:FindFirstChild("PlayerGui"):FindFirstChild(name)
        if obj then pcall(function() obj:Destroy() end) end
    end
end
NuclearClean()
task.wait(0.3)

-- 3. 載入 UI 並設定功能
local success, UIContent = pcall(function()
    return game:HttpGet("https://raw.githubusercontent.com/SLOTH-neo/Sloth/refs/heads/main/UI")
end)

if success then
    local NekoLib = loadstring(UIContent)()
    local myUI, screenGui = NekoLib.new("NEKO BF")

    pcall(function() screenGui.Parent = CoreGui end)
    if screenGui.Parent ~= CoreGui then screenGui.Parent = localPlayer:WaitForChild("PlayerGui") end

    task.spawn(function()
        task.wait(0.2)
        -- ... [省略部分不變的 Tab 設置] ...

        local TabEnv = myUI:Tab("環境優化")
        local VisualSec = TabEnv:Section("視覺增強")
        
        -- ✨ 更新後的視野控制組
        VisualSec:Textbox("視野角度 (FOV)", "80", function(v)
            local num = tonumber(v)
            if num then 
                _G.Settings.FOV = math.clamp(num, 30, 160) -- 限制範圍防止畫面炸裂喵
            end
        end)
        
        VisualSec:Textbox("鏡頭距離 (Zoom)", "128", function(v)
            local num = tonumber(v)
            if num then 
                _G.Settings.MaxZoom = math.clamp(num, 1, 10000)
            end
        end)
        
        -- ... [其餘移動、果實、戰鬥分頁保持不變] ...
        
        -- 移動分頁範例 (加速與跳躍)
        local TabMove = myUI:Tab("移動傳送")
        local M1 = TabMove:Section("角色移動")
        M1:Toggle("開啟移動加速", function(s) _G.Settings.SpeedEnabled = s end)
        M1:Textbox("加速數值", "50", function(v)
            local num = tonumber(v)
            if num then _G.Settings.CatSpeedValue = num end
        end)
    end)
end

-- 無限跳躍與超級跳 (維持原本邏輯)
UserInputService.JumpRequest:Connect(function()
    local hum = localPlayer.Character and localPlayer.Character:FindFirstChildOfClass("Humanoid")
    if not hum then return end
    if _G.Settings.SuperJumpEnabled then
        hum.JumpPower = _G.Settings.SuperJumpHeight
        hum:ChangeState(Enum.HumanoidStateType.Jumping)
    elseif _G.Settings.InfJump then
        hum:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

print("NEKO CORE V2 (FOV + ZOOM) LOADED.")
