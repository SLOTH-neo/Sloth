local services = setmetatable({}, {__index = function(_, k) return game:GetService(k) end})
local ts = services.TweenService
local plr = services.Players.LocalPlayer
local run = services.RunService
local uis = services.UserInputService

local function Tween(obj, info, prop)
    local t = ts:Create(obj, TweenInfo.new(unpack(info)), prop)
    t:Play()
    return t
end

local C = {
    Accent = Color3.fromRGB(255, 120, 180),
    MainBG = Color3.fromRGB(15, 15, 18),
    BtnBG  = Color3.fromRGB(30, 30, 35),
    Text   = Color3.fromRGB(220, 220, 225),
    Stroke = Color3.fromRGB(255, 255, 255),
}

local main = Instance.new("ScreenGui", services.CoreGui)
main.Name = "NekoFly_Fixed"
main.ResetOnSpawn = false

local Frame = Instance.new("Frame", main)
Frame.Size = UDim2.new(0, 200, 0, 115) 
Frame.Position = UDim2.new(0.1, 0, 0.4, 0)
Frame.BackgroundColor3 = C.MainBG
Frame.BackgroundTransparency = 0.1
Frame.BorderSizePixel = 0
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 12)

local GlassStroke = Instance.new("UIStroke", Frame)
GlassStroke.Thickness = 1; GlassStroke.Color = C.Stroke; GlassStroke.Transparency = 0.85

local function CreateStyledButton(name, text, pos, size)
    local b = Instance.new("TextButton", Frame)
    b.Name = name; b.Text = text; b.Position = pos; b.Size = size
    b.BackgroundColor3 = C.BtnBG; b.TextColor3 = C.Text; b.Font = "GothamMedium"; b.TextSize = 11
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)
    b.MouseButton1Down:Connect(function() Tween(b, {0.1}, {Size = UDim2.new(size.X.Scale, size.X.Offset-3, size.Y.Scale, size.Y.Offset-3)}) end)
    b.MouseButton1Up:Connect(function() Tween(b, {0.2, Enum.EasingStyle.Back}, {Size = size}) end)
    return b
end

local up = CreateStyledButton("up", "UP ðŸ¾", UDim2.new(0.05, 0, 0.08, 0), UDim2.new(0, 44, 0, 28))
local down = CreateStyledButton("down", "DOWN ðŸ¾", UDim2.new(0.05, 0, 0.36, 0), UDim2.new(0, 44, 0, 28))
local plus = CreateStyledButton("plus", "+", UDim2.new(0.3, 0, 0.08, 0), UDim2.new(0, 35, 0, 28))
local mine = CreateStyledButton("mine", "-", UDim2.new(0.3, 0, 0.36, 0), UDim2.new(0, 35, 0, 28))
local onof = CreateStyledButton("onof", "è²“é£›è¡Œ", UDim2.new(0.72, 0, 0.36, 0), UDim2.new(0, 50, 0, 28))
local noclipBtn = CreateStyledButton("nc", "ç©¿ç‰†æ¨¡å¼: é—œ", UDim2.new(0.05, 0, 0.7, 0), UDim2.new(0, 185, 0, 25))

local TextLabel = Instance.new("TextLabel", Frame)
TextLabel.Text = "è²“è²“é£›è¡Œ V3"; TextLabel.Size = UDim2.new(0, 80, 0, 28); TextLabel.Position = UDim2.new(0.52, 0, 0.08, 0)
TextLabel.TextColor3 = C.Accent; TextLabel.Font = "GothamBold"; TextLabel.TextSize = 13; TextLabel.BackgroundTransparency = 1

local speed = Instance.new("TextLabel", Frame)
speed.Text = "1"; speed.Size = UDim2.new(0, 40, 0, 28); speed.Position = UDim2.new(0.52, 0, 0.36, 0)
speed.TextColor3 = Color3.new(1, 1, 1); speed.Font = "GothamBold"; speed.TextSize = 14; speed.BackgroundTransparency = 1

local closebutton = CreateStyledButton("Close", "ðŸ±", UDim2.new(0, -35, 0, 0), UDim2.new(0, 30, 0, 30))
local mini = CreateStyledButton("minimize", "-", UDim2.new(1, 5, 0, 0), UDim2.new(0, 30, 0, 30))
local mini2 = CreateStyledButton("minimize2", "+", UDim2.new(1, 5, 0, 35), UDim2.new(0, 30, 0, 30)); mini2.Visible = false

-- [[ ðŸ§  æ ¸å¿ƒé‚è¼¯ - ä½ çš„é‚è¼¯åŽŸç”Ÿç§»æ¤ç‰ˆ ]]
local speeds = 1
local nowe = false
local tpwalking = false
local noclip = false
local speaker = plr

-- ç©¿ç‰†ç›£è½ (å®Œå…¨ä½¿ç”¨åŽŸç‰ˆå¯«æ³•ï¼Œä¸èˆ‡é£›è¡Œè¡çª)
run.Stepped:Connect(function()
    if noclip and speaker.Character then
        for _, v in pairs(speaker.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
    end
end)

noclipBtn.MouseButton1Click:Connect(function()
    noclip = not noclip
    noclipBtn.Text = noclip and "ç©¿ç‰†æ¨¡å¼: é–‹ ðŸ¾" or "ç©¿ç‰†æ¨¡å¼: é—œ"
    Tween(noclipBtn, {0.2}, {BackgroundColor3 = noclip and C.Accent or C.BtnBG})
end)

onof.MouseButton1Click:Connect(function()
    if nowe == true then
        nowe = false
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Climbing,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Flying,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Freefall,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.GettingUp,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Landed,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Physics,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,true)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Swimming,true)
        speaker.Character.Humanoid:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
        Tween(onof, {0.2}, {BackgroundColor3 = C.BtnBG})
        tpwalking = false
    else 
        nowe = true
        Tween(onof, {0.2}, {BackgroundColor3 = C.Accent})
        
        tpwalking = true
        for i = 1, speeds do
            spawn(function()
                local hb = run.Heartbeat    
                while tpwalking and hb:Wait() and speaker.Character and speaker.Character:FindFirstChild("Humanoid") do
                    if speaker.Character.Humanoid.MoveDirection.Magnitude > 0 then
                        speaker.Character:TranslateBy(speaker.Character.Humanoid.MoveDirection)
                    end
                end
            end)
        end
        
        speaker.Character.Animate.Disabled = true
        local Hum = speaker.Character:FindFirstChildOfClass("Humanoid")
        for i,v in next, Hum:GetPlayingAnimationTracks() do v:AdjustSpeed(0) end
        
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Climbing,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Flying,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Freefall,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.GettingUp,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Landed,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Physics,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,false)
        speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Swimming,false)
        speaker.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Swimming)

        local isR6 = speaker.Character.Humanoid.RigType == Enum.HumanoidRigType.R6
        local torso = isR6 and speaker.Character:FindFirstChild("Torso") or speaker.Character:FindFirstChild("UpperTorso")
        local ctrl = {f = 0, b = 0, l = 0, r = 0}
        local lastctrl = {f = 0, b = 0, l = 0, r = 0}
        local maxspeed = 50
        local curspeed = 0

        local bg = Instance.new("BodyGyro", torso)
        bg.P = 9e4; bg.maxTorque = Vector3.new(9e9, 9e9, 9e9); bg.cframe = torso.CFrame
        local bv = Instance.new("BodyVelocity", torso)
        bv.velocity = Vector3.new(0,0.1,0); bv.maxForce = Vector3.new(9e9, 9e9, 9e9)

        speaker.Character.Humanoid.PlatformStand = true

        spawn(function()
            while nowe do
                run.RenderStepped:Wait()
                ctrl.f = uis:IsKeyDown(Enum.KeyCode.W) and 1 or 0
                ctrl.b = uis:IsKeyDown(Enum.KeyCode.S) and -1 or 0
                ctrl.l = uis:IsKeyDown(Enum.KeyCode.A) and -1 or 0
                ctrl.r = uis:IsKeyDown(Enum.KeyCode.D) and 1 or 0

                if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
                    curspeed = curspeed + .5 + (curspeed/maxspeed)
                    if curspeed > maxspeed then curspeed = maxspeed end
                elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and curspeed ~= 0 then
                    curspeed = curspeed - 1
                    if curspeed < 0 then curspeed = 0 end
                end
                if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
                    bv.velocity = ((workspace.CurrentCamera.CFrame.lookVector * (ctrl.f+ctrl.b)) + ((workspace.CurrentCamera.CFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0).p) - workspace.CurrentCamera.CFrame.p)) * curspeed
                    lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
                elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and curspeed ~= 0 then
                    bv.velocity = ((workspace.CurrentCamera.CFrame.lookVector * (lastctrl.f+lastctrl.b)) + ((workspace.CurrentCamera.CFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0).p) - workspace.CurrentCamera.CFrame.p)) * curspeed
                else
                    bv.velocity = Vector3.new(0,0,0)
                end
                bg.cframe = workspace.CurrentCamera.CFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*curspeed/maxspeed),0,0)
            end
            bg:Destroy(); bv:Destroy()
            if speaker.Character:FindFirstChild("Humanoid") then
                speaker.Character.Humanoid.PlatformStand = false
                speaker.Character.Animate.Disabled = false
            end
        end)
    end
end)

-- é€Ÿåº¦èˆ‡ä¸Šä¸‹
local function updateSpeed()
    speed.Text = speeds
    if nowe then
        tpwalking = false; wait()
        tpwalking = true
        for i = 1, speeds do
            spawn(function()
                local hb = run.Heartbeat
                while tpwalking and hb:Wait() and speaker.Character:FindFirstChild("Humanoid") do
                    if speaker.Character.Humanoid.MoveDirection.Magnitude > 0 then speaker.Character:TranslateBy(speaker.Character.Humanoid.MoveDirection) end
                end
            end)
        end
    end
end
plus.MouseButton1Click:Connect(function() speeds = math.min(speeds + 1, 150) updateSpeed() end)
mine.MouseButton1Click:Connect(function() speeds = math.max(speeds - 1, 1) updateSpeed() end)

local tis; up.MouseButton1Down:Connect(function() tis = true; while tis do wait() speaker.Character:TranslateBy(Vector3.new(0,1,0)) end end)
up.MouseButton1Up:Connect(function() tis = false end); up.MouseLeave:Connect(function() tis = false end)
local dis; down.MouseButton1Down:Connect(function() dis = true; while dis do wait() speaker.Character:TranslateBy(Vector3.new(0,-1,0)) end end)
down.MouseButton1Up:Connect(function() dis = false end); down.MouseLeave:Connect(function() dis = false end)

-- UI æŽ§åˆ¶
local function toggleVis(v) for _, x in pairs(Frame:GetChildren()) do if x:IsA("TextButton") or x:IsA("TextLabel") then x.Visible = v end end end
mini.MouseButton1Click:Connect(function() toggleVis(false); mini2.Visible = true; closebutton.Visible = true; Tween(Frame, {0.3}, {Size = UDim2.new(0, 45, 0, 45)}) end)
mini2.MouseButton1Click:Connect(function() Tween(Frame, {0.3}, {Size = UDim2.new(0, 200, 0, 115)}); task.wait(0.3); toggleVis(true); mini2.Visible = false end)
closebutton.MouseButton1Click:Connect(function() nowe = false; noclip = false; main:Destroy() end)

-- æ‹–å‹•
local dStart, sPos, drag; Frame.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then drag = true; dStart = i.Position; sPos = Frame.Position end end)
uis.InputChanged:Connect(function(i) if drag and i.UserInputType == Enum.UserInputType.MouseMovement then local d = i.Position - dStart; Frame.Position = UDim2.new(sPos.X.Scale, sPos.X.Offset + d.X, sPos.Y.Scale, sPos.Y.Offset + d.Y) end end)
uis.InputEnded:Connect(function() drag = false end)
